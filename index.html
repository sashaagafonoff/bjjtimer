<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BJJ Timer (TV)</title>
<style>
  :root {
    --bg:#000; --fg:#fff; --fight:#1db954; --rest:#ffae00; --end:#ff3b30; --muted:#9aa0a6;
    --track:#141414; --trail:#262626;
  }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  .wrap { position:relative; display:flex; flex-direction:column; height:100%;
    gap:1.5vh; padding:2vh 3vw; overflow:hidden; }

  /* ===== Stage (ring + logo centered) ===== */
  .stage { flex:1; display:flex; align-items:center; justify-content:center; z-index:1; }
  .ring {
    position: relative;
    width:min(70vh,80vw); height:min(70vh,80vw);
    border-radius:50%;
    overflow:hidden;
    background: radial-gradient(circle at 50% 50%, #000 0 62%, transparent 62.1%),
                conic-gradient(var(--trail) 0turn, var(--trail) 1turn);
    box-shadow: 0 0 0 1.2vh #111 inset, 0 0 30px rgba(0,0,0,.6) inset;
  }
  .ring::before{
    content:"";
    position:absolute; inset:0;
    background: conic-gradient(var(--fight) var(--deg,0deg), var(--track) var(--deg,0deg));
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 0 62%, #000 62.1%);
            mask: radial-gradient(circle at 50% 50%, transparent 0 62%, #000 62.1%);
  }
  .ring::after{
    content:"";
    position:absolute; inset:0;
    background:
      conic-gradient(from 0deg, rgba(255,255,255,.08) 0deg 2deg, transparent 2deg 36deg);
    background-size: 36deg 36deg;
    -webkit-mask: radial-gradient(circle at 50% 50%, transparent 0 62%, #000 62.1%);
            mask: radial-gradient(circle at 50% 50%, transparent 0 62%, #000 62.1%);
    pointer-events:none;
  }

  /* Perfect center logo */
  .logo {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:40%; height:auto; opacity:.9; pointer-events:none;
  }

  /* Big status text */
  .badge {
    position:absolute; left:50%; bottom:8%; transform:translateX(-50%);
    text-align:center; font-weight:900; letter-spacing:.02em;
    font-size: clamp(4vh, 5vw, 8vh);
    text-shadow: 0 0 14px rgba(0,0,0,.65);
  }

  .subinfo { text-align:center; margin-top:.5vh; font-size:3.8vh; color:var(--muted); z-index:2; }

  /* ===== Floating HUDs ===== */
  .hud { position: fixed; top: 2vh; z-index: 5; display:flex; flex-direction:column; gap:1vh; }
  .hud .box {
    background: rgba(0,0,0,.55); border: 1px solid #333; border-radius: .8vh;
    padding: 1.2vh 1.4vw; color:#ddd; backdrop-filter: blur(4px);
  }
  .hud.right { right: 2vw; align-items:flex-end; }
  .hud.right .box { max-width: 30vw; font-size: 2.4vh; }
  .hud.right .breaks { font-weight:700; color:#fff; font-size:2.6vh; }

  .hud.left { left: 2vw; align-items:flex-start; }
  .hud.left .box { font-size: 2.6vh; }
  .hud.left .btns { display:flex; flex-direction:column; gap:.8vh; }
  .hud.left button {
    font-size:3vh; padding:1vh 2vw; background:#111; color:#fff;
    border:1px solid #333; border-radius:.8vh; width: 18vw; max-width: 320px;
    text-align:center;
  }
  .hud.left button:active { transform: scale(.98); }
  .hud.left .row { display:flex; gap:.6vw; align-items:center; margin-top:.6vh; }
  .hud.left .label { color:#cfd3d7; min-width: 8.5vw; }
  .hud.left .value { font-weight:700; color:#fff; min-width: 6vw; text-align:center; }
  .hud.left .mini button { font-size:2.6vh; padding:.6vh 1vw; width:auto; }

  /* ===== Full-screen timer overlay with fixed cells (no jitter) ===== */
  .timeOverlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    pointer-events:none; z-index:3;
    font-weight:900; line-height:1; letter-spacing:0; font-variant-numeric: tabular-nums;
    font-size: clamp(22vh, 28vw, 60vh);
    opacity:.6;
    text-shadow: 0 0 25px rgba(0,0,0,.7), 0 0 60px rgba(0,0,0,.35);
    color:#fff; /* paused/inactive default */
  }
  .timeGrid { display:flex; align-items:center; justify-content:center; gap:.08em; }
  .digit, .sep {
    display:flex; align-items:center; justify-content:center;
    height:1em;
  }
  /* Equal space for each NUMBER (4 digits). Colon is its own narrow cell. */
  .digit { width: .78em; }
  .sep   { width: .38em; opacity:.9; }

  /* State colors */
  .fighting .timeOverlay { color: var(--fight); }
  .resting  .timeOverlay { color: var(--rest); }
  .ended    .timeOverlay { color: var(--end); }

  /* Dynamic ring tint */
  .fighting .ring::before { background: conic-gradient(var(--fight) var(--deg,0deg), var(--track) var(--deg,0deg)); }
  .resting  .ring::before { background: conic-gradient(var(--rest)  var(--deg,0deg), var(--track) var(--deg,0deg)); }
  .ended    .ring::before { background: conic-gradient(var(--end)   var(--deg,0deg), var(--track) var(--deg,0deg)); }

  /* Pre-start overlay */
  .prestart { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:4; }
  .prebox { padding:3vh 5vw; border:2px solid #444; border-radius:1vh; background:#111; text-align:center; }
  .pretitle { font-size:4vh; color:#cde; margin-bottom:1vh; }
  .pretime { font-size:14vh; font-weight:800; }

  .foot { text-align:center; font-size:2.4vh; color:var(--muted); margin-top:auto; z-index:2; }
</style>
</head>
<body>
  <!-- RIGHT HUD: Breaks + Tips -->
  <aside class="hud right">
    <div class="box breaks" id="breaksBox">Breaks: 1:00</div>
    <div class="box tips">
      OK/Enter = Start/Pause<br/>
      Back/Esc = Reset<br/>
      0 = Fullscreen<br/>
      ▲/▼ = ±1 min &nbsp;•&nbsp; ◄/► = ±1 round
    </div>
  </aside>

  <!-- LEFT HUD: Vertical controls + settings -->
  <aside class="hud left">
    <div class="box">
      <div class="btns">
        <button id="startPause">Start</button>
        <button id="reset">Reset</button>
        <button id="fullscreen">Fullscreen</button>
      </div>

      <div class="row mini" style="margin-top:1.2vh;">
        <div class="label">Match</div>
        <div class="value" id="matchLenLbl">05:00</div>
        <button id="minusMin">−1m</button>
        <button id="plusMin">+1m</button>
      </div>

      <div class="row mini">
        <div class="label">Rounds</div>
        <div class="value" id="roundsLbl">5</div>
        <button id="minusRnd">−1</button>
        <button id="plusRnd">+1</button>
      </div>

      <div class="row" style="margin-top:.8vh;">
        <div class="label">Break</div>
        <div class="value" id="breakLbl">01:00</div>
      </div>
    </div>
  </aside>

  <div class="wrap">
    <div class="stage">
      <div class="ring" id="ring" style="--deg:0deg">
        <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'"/>
        <div class="badge" id="phaseBadge">READY</div>
      </div>
    </div>

    <div class="subinfo" id="rounds">Round 1 / 5</div>
    <div class="foot">BJJ Timer • v0.8</div>
  </div>

  <!-- Giant full-screen timer (fixed cells) -->
  <div class="timeOverlay" aria-hidden="true">
    <div class="timeGrid">
      <div class="digit" id="d1">0</div>
      <div class="digit" id="d2">5</div>
      <div class="sep">:</div>
      <div class="digit" id="d3">0</div>
      <div class="digit" id="d4">0</div>
    </div>
  </div>

  <!-- Pre-start overlay -->
  <div class="prestart" id="preOverlay" aria-hidden="true">
    <div class="prebox">
      <div class="pretitle">Get Ready</div>
      <div class="pretime" id="preClock">00:10</div>
    </div>
  </div>

<script>
/* ===== Audio (WebAudio): 3-2-1 beeps + bell ===== */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function tone(freq=880, ms=200, type='sine', gain=0.22){
  try{
    ensureAudio();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime; o.start(t);
    g.gain.setValueAtTime(gain,t);
    g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000);
    o.stop(t+ms/1000+0.02);
  }catch{}
}
function beep(){ tone(1000,180,'sine',0.26); }
function bell(){ tone(660,250,'triangle',0.32); setTimeout(()=>tone(440,350,'sine',0.26),40); setTimeout(()=>tone(880,200,'sine',0.18),60); }

/* ===== Elements ===== */
const roundsEl=document.getElementById('rounds');
const badgeEl=document.getElementById('phaseBadge');
const matchLenLbl=document.getElementById('matchLenLbl');
const roundsLbl=document.getElementById('roundsLbl');
const breakLbl=document.getElementById('breakLbl');
const ringEl=document.getElementById('ring');
const preOverlay=document.getElementById('preOverlay');
const preClock=document.getElementById('preClock');
const breaksBox=document.getElementById('breaksBox');

const btnMinus=document.getElementById('minusMin');
const btnPlus=document.getElementById('plusMin');
const btnMinusR=document.getElementById('minusRnd');
const btnPlusR=document.getElementById('plusRnd');
const btnStart=document.getElementById('startPause');
const btnReset=document.getElementById('reset');
const btnFS=document.getElementById('fullscreen');

/* Timer digits */
const d1=document.getElementById('d1');
const d2=document.getElementById('d2');
const d3=document.getElementById('d3');
const d4=document.getElementById('d4');

/* ===== Config / State ===== */
const BREAK_SEC=60, PRESTART_SEC=10;
let matchSec=5*60, roundsTotal=5, roundNum=1;
let phase='ready'; // 'ready'|'pre'|'run'|'break'|'done'
let remaining=matchSec, running=false;
let rafId=null, lastTs=null;

/* ===== Helpers ===== */
function fmt(sec){ sec=Math.max(0,Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60; return {m,s,txt:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}; }
function progressDeg(){
  const total = phase==='run' ? matchSec : phase==='break' ? BREAK_SEC : phase==='pre' ? PRESTART_SEC : 1;
  const done = total - remaining;
  const pct = Math.max(0,Math.min(1, done/total));
  return Math.floor(360*pct);
}
function updateDigits(sec){
  const t = fmt(sec);
  const mm = String(t.m).padStart(2,'0');
  const ss = String(t.s).padStart(2,'0');
  d1.textContent = mm[0];
  d2.textContent = mm[1];
  d3.textContent = ss[0];
  d4.textContent = ss[1];
}

/* ===== UI ===== */
function updateRing(){
  ringEl.style.setProperty('--deg', progressDeg()+'deg');
}
function updateUI(){
  // digits overlay
  updateDigits(remaining);

  // side labels
  const t = fmt(remaining);
  roundsEl.textContent = `Round ${Math.min(roundNum,roundsTotal)} / ${roundsTotal}` + (phase==='break'?'  (REST)':'');
  matchLenLbl.textContent = fmt(matchSec).txt;
  roundsLbl.textContent = String(roundsTotal);
  breakLbl.textContent = fmt(BREAK_SEC).txt;
  breaksBox.textContent = `Breaks: ${fmt(BREAK_SEC).txt}`;

  // status text
  badgeEl.textContent =
    phase==='pre'  ? 'GET READY' :
    phase==='run'  ? 'FIGHT'     :
    phase==='break'? 'REST'      :
    phase==='done' ? 'FINISHED'  : 'READY';

  // body classes for color tint
  document.body.classList.remove('fighting','resting','ended');
  if(phase==='run') document.body.classList.add('fighting');
  else if(phase==='break') document.body.classList.add('resting');
  else if(phase==='done') document.body.classList.add('ended');

  // pre-start overlay
  preOverlay.style.display = (phase==='pre') ? 'flex' : 'none';
  preClock.textContent = fmt(remaining).txt;

  // button label
  btnStart.textContent = running ? 'Pause' : (phase==='done' ? 'Restart' : 'Start');

  updateRing();
}

/* ===== Flow control ===== */
function startPre(){
  ensureAudio();
  phase='pre'; remaining=PRESTART_SEC; running=true; lastTs=null;
  rafId=requestAnimationFrame(loop);
  updateUI();
}
function startRun(){ phase='run'; remaining=matchSec; lastTs=null; updateUI(); }
function nextOrFinish(){
  if(roundNum>=roundsTotal){ phase='done'; running=false; }
  else { phase='break'; remaining=BREAK_SEC; lastTs=null; }
  updateUI();
}
function loop(ts){
  if(!running) return;
  if(lastTs==null) lastTs=ts||performance.now();
  const now=ts||performance.now(), dt=(now-lastTs)/1000; lastTs=now;

  const prev=remaining;
  remaining=Math.max(0,remaining-dt);

  if(phase==='pre'){
    const psec=Math.ceil(prev), nsec=Math.ceil(remaining);
    if([3,2,1].includes(psec) && nsec<psec) beep();
    if(remaining===0){ bell(); startRun(); }
  } else if(phase==='run'){
    if(prev>10 && remaining<=10) beep();
    if(remaining===0){ bell(); roundNum++; nextOrFinish(); }
  } else if(phase==='break'){
    if(remaining===0){ bell(); phase='run'; remaining=matchSec; lastTs=now; }
  }

  updateUI();
  rafId=requestAnimationFrame(loop);
}

/* ===== Controls ===== */
function startPause(){
  if(running){ running=false; cancelAnimationFrame(rafId); lastTs=null; }
  else{
    if(phase==='ready' || phase==='done'){ resetAll(); startPre(); }
    else { running=true; lastTs=null; rafId=requestAnimationFrame(loop); }
  }
  updateUI();
}
function resetAll(){
  running=false; cancelAnimationFrame(rafId); lastTs=null;
  phase='ready'; roundNum=1; remaining=matchSec; updateUI();
}
function changeMinutes(d){
  matchSec=Math.max(60,Math.min(20*60,matchSec+d*60)); // 1–20 min
  if(phase==='ready'||phase==='done') remaining=matchSec;
  updateUI();
}
function changeRounds(d){
  roundsTotal=Math.max(1,Math.min(20,roundsTotal+d));
  if(roundNum>roundsTotal) roundNum=roundsTotal;
  updateUI();
}
function toggleFS(){
  const el=document.documentElement;
  if(!document.fullscreenElement && el.requestFullscreen) el.requestFullscreen();
  else if(document.exitFullscreen) document.exitFullscreen();
}

/* Wire up */
btnMinus.onclick=()=>changeMinutes(-1);
btnPlus.onclick =()=>changeMinutes(1);
btnMinusR.onclick=()=>changeRounds(-1);
btnPlusR.onclick =()=>changeRounds(1);
btnStart.onclick =startPause;
btnReset.onclick =resetAll;
btnFS.onclick    =toggleFS;

/* Remote / Keyboard */
addEventListener('keydown',(e)=>{
  switch(e.key){
    case 'Enter': case ' ': startPause(); break;
    case 'Backspace': case 'Escape': resetAll(); break;
    case '0': toggleFS(); break;
    case 'ArrowUp': changeMinutes(1); break;
    case 'ArrowDown': changeMinutes(-1); break;
    case 'ArrowRight': changeRounds(1); break;
    case 'ArrowLeft': changeRounds(-1); break;
  }
});

/* Init */
updateUI();
</script>
</body>
</html>
