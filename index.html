<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BJJ Timer (TV)</title>
<style>
  :root { --bg:#000; --fg:#fff; --ok:#1db954; --warn:#ffae00; --end:#ff3b30; --rest:#0091ff; --muted:#9aa0a6; }
  html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  .wrap { display:flex; flex-direction:column; height:100%; align-items:center; justify-content:space-between; padding:2vh 3vw; }
  .top { width:100%; display:flex; justify-content:space-between; align-items:center; font-size:3vh; opacity:.9; }
  .muted { color:var(--muted); }
  .main { display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .time { font-weight:800; font-variant-numeric:tabular-nums; letter-spacing:.02em; line-height:1; }
  @media (min-aspect-ratio:16/9){ .time{ font-size:28vh; } }
  @media (max-aspect-ratio:16/9){ .time{ font-size:22vw; } }
  .rounds { margin-top:1vh; font-size:4vh; color:var(--muted); }
  .status { margin-top:2vh; font-size:5vh; font-weight:700; }
  .controls { width:100%; display:flex; justify-content:center; gap:2vw; flex-wrap:wrap; }
  button { font-size:3.5vh; padding:1vh 2vw; background:#111; color:#fff; border:1px solid #333; border-radius:.75vh; }
  button:active { transform:scale(.98); }
  .panel { display:flex; gap:2vw; margin-top:2vh; }
  .panel > div { text-align:center; }
  .panel .label { font-size:2.5vh; color:var(--muted); }
  .panel .value { font-size:4vh; margin-top:.5vh; }
  .ring { width:40vh; height:40vh; border-radius:50%; border:.9vh solid #333; position:relative; box-shadow:inset 0 0 0 .9vh #111; margin-bottom:3vh; background: conic-gradient(var(--ok) 0deg, #222 0deg); }
  .badge { position:absolute; inset:auto 0 0 0; margin:auto; text-align:center; font-size:3.2vh; color:#fff; opacity:.8; }
  .prestart { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); }
  .prebox { padding:3vh 5vw; border:2px solid #444; border-radius:1vh; background:#111; text-align:center; }
  .pretitle { font-size:4vh; color:#cde; margin-bottom:1vh; }
  .pretime { font-size:14vh; font-weight:800; }
  .warn .time { color:var(--warn); }
  .rest .time { color:var(--rest); }
  .end .time { color:var(--end); }
  .foot { font-size:2.6vh; opacity:.7; }
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="top">
    <div class="muted">OK/Enter=Start/Pause • ▲/▼ Time • ◄/► Rounds • Back=Reset • 0=Fullscreen</div>
    <div class="muted">1‑min breaks auto</div>
  </div>

  <div class="main">
    <div class="ring" id="ring"><div class="badge" id="phaseBadge">Ready</div></div>
    <div class="time" id="clock">05:00</div>
    <div class="rounds" id="rounds">Round 1 / 5</div>

    <div class="panel">
      <div>
        <div class="label">Match Time</div>
        <div class="value" id="matchLenLbl">5:00</div>
        <div>
          <button id="minusMin">−1 min</button>
          <button id="plusMin">+1 min</button>
        </div>
      </div>
      <div>
        <div class="label">Rounds</div>
        <div class="value" id="roundsLbl">5</div>
        <div>
          <button id="minusRnd">−1</button>
          <button id="plusRnd">+1</button>
        </div>
      </div>
      <div>
        <div class="label">Break</div>
        <div class="value">1:00 (fixed)</div>
      </div>
    </div>

    <div class="status" id="status">Ready</div>

    <div class="controls">
      <button id="startPause">Start</button>
      <button id="reset">Reset</button>
      <button id="fullscreen">Fullscreen</button>
    </div>
  </div>

  <div class="foot">BJJ Timer • v0.2</div>
</div>

<!-- Pre‑start overlay -->
<div class="prestart" id="preOverlay" aria-hidden="true">
  <div class="prebox">
    <div class="pretitle">Get Ready</div>
    <div class="pretime" id="preClock">00:10</div>
  </div>
</div>

<script>
/* ===================== Audio (WebAudio beeps & bell) ===================== */
let audioCtx = null;
function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function tone(freq=880, ms=200, type='sine', gain=0.2) {
  try {
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    // simple decay
    g.gain.setValueAtTime(gain, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
    o.stop(audioCtx.currentTime + ms/1000 + 0.02);
  } catch {}
}
function beep() { tone(1000, 180, 'sine', 0.25); }
function bell() {
  // simple “rings” chord
  tone(660, 250, 'triangle', 0.3);
  setTimeout(()=>tone(440, 350, 'sine', 0.25), 40);
  setTimeout(()=>tone(880, 200, 'sine', 0.18), 60);
}

/* ===================== Elements ===================== */
const clockEl = document.getElementById('clock');
const roundsEl = document.getElementById('rounds');
const statusEl = document.getElementById('status');
const ringEl = document.getElementById('ring');
const badgeEl = document.getElementById('phaseBadge');
const matchLenLbl = document.getElementById('matchLenLbl');
const roundsLbl = document.getElementById('roundsLbl');
const preOverlay = document.getElementById('preOverlay');
const preClock = document.getElementById('preClock');

const btnMinus = document.getElementById('minusMin');
const btnPlus  = document.getElementById('plusMin');
const btnMinusR= document.getElementById('minusRnd');
const btnPlusR = document.getElementById('plusRnd');
const btnStart = document.getElementById('startPause');
const btnReset = document.getElementById('reset');
const btnFS    = document.getElementById('fullscreen');

/* ===================== Config / State ===================== */
const BREAK_SEC = 60;  // fixed 1 minute
const PRESTART_SEC = 10;

let matchSec = 5*60;   // editable
let roundsTotal = 5;   // editable
let roundNum = 1;

let phase = 'ready';   // 'ready' | 'pre' | 'run' | 'break' | 'done' | 'paused'
let remaining = matchSec;
let running = false;

let rafId = null;
let lastTs = null;

function fmt(sec) {
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function updateRing() {
  let total = (phase==='run') ? matchSec :
              (phase==='break') ? BREAK_SEC :
              (phase==='pre') ? PRESTART_SEC : 1;
  const done = total - remaining;
  const pct = Math.max(0, Math.min(1, done/total));
  const deg = Math.floor(360*pct);
  let col = '#222';
  if (phase==='pre') col = '#8888ff';
  else if (phase==='run') col = (remaining<=10) ? '#ffae00' : '#1db954';
  else if (phase==='break') col = '#0091ff';
  else if (phase==='done') col = '#ff3b30';
  ringEl.style.background = `conic-gradient(${col} ${deg}deg, #222 ${deg}deg)`;
}

function updateUI() {
  clockEl.textContent = fmt(remaining);
  roundsEl.textContent = `Round ${Math.min(roundNum, roundsTotal)} / ${roundsTotal}` + (phase==='break'?'  (REST)':'');
  matchLenLbl.textContent = fmt(matchSec);
  roundsLbl.textContent = String(roundsTotal);

  badgeEl.textContent =
    phase==='pre'? 'Get Ready' :
    phase==='run'? 'Fight' :
    phase==='break'? 'Rest' :
    phase==='done'? 'Finished' : 'Ready';

  statusEl.textContent =
    phase==='run' ? (remaining<=10 ? 'Warning' : 'Running') :
    phase==='break' ? 'Break' :
    phase==='pre' ? 'Pre‑start' :
    phase==='done' ? 'Done' : 'Ready';

  document.body.classList.toggle('warn', phase==='run' && remaining<=10);
  document.body.classList.toggle('rest', phase==='break');
  document.body.classList.toggle('end', phase==='done');

  btnStart.textContent = (running ? 'Pause' : (phase==='done' ? 'Restart' : 'Start'));
  updateRing();

  // Overlay for pre‑start
  preOverlay.style.display = (phase==='pre') ? 'flex' : 'none';
  preClock.textContent = fmt(remaining);
}

/* ===================== Flow control ===================== */
function startPrestart() {
  ensureAudio();
  phase = 'pre';
  remaining = PRESTART_SEC;
  running = true;
  lastTs = null;
  loop();
  updateUI();
}

function startRun() {
  phase = 'run';
  remaining = matchSec;
  lastTs = null;
  updateUI();
}

function startBreak() {
  phase = 'break';
  remaining = BREAK_SEC;
  lastTs = null;
  updateUI();
}

function finishOrNextRound() {
  if (roundNum >= roundsTotal) {
    phase = 'done';
    running = false;
  } else {
    phase = 'break';
    remaining = BREAK_SEC;
  }
  updateUI();
}

function loop(ts) {
  if (!running) return;
  if (lastTs == null) lastTs = ts || performance.now();
  const now = ts || performance.now();
  const dt = (now - lastTs)/1000;
  lastTs = now;

  const prev = remaining;
  remaining = Math.max(0, remaining - dt);

  // Pre‑start beeps at 3,2,1
  if (phase==='pre') {
    const psec = Math.ceil(prev);
    const nsec = Math.ceil(remaining);
    if ([3,2,1].includes(psec) && nsec < psec) beep();
    if (remaining === 0) {
      bell();
      startRun();
    }
  }
  else if (phase==='run') {
    if (prev > 10 && remaining <= 10) beep(); // single 10s warning (optional)
    if (remaining === 0) {
      bell();
      // end of round
      roundNum++;
      finishOrNextRound();
    }
  }
  else if (phase==='break') {
    if (remaining === 0) {
      // start next round
      bell();
      phase = 'run';
      remaining = matchSec;
      lastTs = now;
    }
  }

  updateUI();
  rafId = requestAnimationFrame(loop);
}

/* ===================== Controls ===================== */
function startPause() {
  if (running) {
    running = false; cancelAnimationFrame(rafId); lastTs = null;
    statusEl.textContent = 'Paused';
    btnStart.textContent = 'Resume';
  } else {
    if (phase==='ready' || phase==='done') {
      // Restart from scratch
      resetAll();
      startPrestart();
    } else {
      running = true; lastTs = null; rafId = requestAnimationFrame(loop);
    }
    updateUI();
  }
}

function resetAll() {
  running = false;
  cancelAnimationFrame(rafId);
  lastTs = null;
  phase = 'ready';
  roundNum = 1;
  remaining = matchSec;
  updateUI();
}

function changeMinutes(delta) {
  const newVal = Math.max(60, Math.min(20*60, matchSec + delta*60)); // 1..20 min
  matchSec = newVal;
  if (phase==='ready' || phase==='done') remaining = matchSec;
  updateUI();
}

function changeRounds(delta) {
  roundsTotal = Math.max(1, Math.min(20, roundsTotal + delta));
  if (roundNum > roundsTotal) roundNum = roundsTotal;
  updateUI();
}

function toggleFullscreen() {
  const el = document.documentElement;
  const isFS = document.fullscreenElement;
  if (!isFS && el.requestFullscreen) el.requestFullscreen();
  else if (document.exitFullscreen) document.exitFullscreen();
}

/* Buttons */
btnMinus.onclick = () => changeMinutes(-1);
btnPlus.onclick  = () => changeMinutes(1);
btnMinusR.onclick= () => changeRounds(-1);
btnPlusR.onclick = () => changeRounds(1);
btnStart.onclick = startPause;
btnReset.onclick = resetAll;
btnFS.onclick    = toggleFullscreen;

/* Remote / Keyboard */
window.addEventListener('keydown', (e) => {
  switch (e.key) {
    case 'Enter':
    case ' ': startPause(); break;
    case 'ArrowUp': changeMinutes(1); break;
    case 'ArrowDown': changeMinutes(-1); break;
    case 'ArrowRight': changeRounds(1); break;
    case 'ArrowLeft': changeRounds(-1); break;
    case 'Backspace':
    case 'Escape': resetAll(); break;
    case '0': toggleFullscreen(); break;
  }
});

/* Init */
updateUI();
</script>
</body>
</html>
